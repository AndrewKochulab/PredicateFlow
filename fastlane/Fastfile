default_platform(:ios)

setup_travis
cocoapods(
  podfile: "./Example/Podfile",
  try_repo_update_on_error: true
)


platform :ios do

  desc "Linting..."
  lane :linting do
    ["PredicateFlow", "PredicateFlow-Realm"].each do |path|
      puts "Linting '#{path}'..."

      swiftlint(
        mode: :lint,
        executable: "Example/Pods/SwiftLint/swiftlint",
        path: path,
        quiet: true,
        ignore_exit_status: true
      )
    end
    
    pod_lib_lint(
      verbose: true,
      quick: true
    )
  end

  desc "Run tests for PredicateFlow"
  lane :test do
    run_tests(
      devices: [
        "iPhone 6s"
      ],
      workspace: "Example/PredicateFlow.xcworkspace",
      scheme: "PredicateFlow-Example",
      code_coverage: true,
      skip_slack: true
    )
  end

  desc "Create documentation"
  lane :documentation do
    jazzy(
      config: ".jazzy.yaml"
    )
  end
  
  desc "Publish documentation"
  lane :publish_doc do
    branch = git_branch
    commit_github_file(
      repository_name: "andreadelfante/PredicateFlow",
      api_token: ENV["GITHUB_TOKEN"],
      message: "Update docs folder",
      branch: branch,
      path: "docs"
    )
  end
  
  desc "Mark a new release to GitHub"
  lane :mark_tag_github do
    version = read_podspec['version']
    set_github_release(
      repository_name: "andreadelfante/PredicateFlow",
      api_token: ENV["GITHUB_TOKEN"],
      name: version,
      tag_name: version,
      commitish: "master"
    )
  end

  desc "Deploy to Cocoapods and push tag to master"
  lane :deploy do
    pod_push
  end
end
