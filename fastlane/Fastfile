default_platform(:ios)

setup_travis
cocoapods(
  podfile: "./Example/Podfile",
  try_repo_update_on_error: true
)


platform :ios do

  desc "Linting..."
  lane :linting do
    ["PredicateFlow", "PredicateFlow-Realm"].each do |path|
      puts "Linting '#{path}'..."

      swiftlint(
        mode: :lint,
        executable: "Example/Pods/SwiftLint/swiftlint",
        path: path,
        quiet: true,
        ignore_exit_status: true
      )
    end
    
    pod_lib_lint(
      verbose: true,
      quick: true
    )
  end

  desc "Linting and fixing..."
  lane :linting_fixing do
    ["PredicateFlow", "PredicateFlow-Realm"].each do |path|
      puts "Linting and fixing '#{path}'..."

      swiftlint(
        mode: :autocorrect,
        executable: "Example/Pods/SwiftLint/swiftlint",
        path: path,
        quiet: true
      )
    end
  end

  desc "Run tests for PredicateFlow"
  lane :test do
    run_tests(
      device: "iPhone 6s",
      workspace: "Example/PredicateFlow.xcworkspace",
      scheme: "PredicateFlow-Example",
      code_coverage: true,
      skip_slack: true,
      derived_data_path: "./build"
    )
    xcov(
      workspace: "Example/PredicateFlow.xcworkspace",
      scheme: "PredicateFlow-Example",
      html_report: true,
      json_report: true,
      markdown_report: true,
      derived_data_path: "./build"
    )
  end

  desc "Create documentation"
  lane :documentation do
    jazzy(
      config: ".jazzy.yaml"
    )
    
    version = read_podspec['version']
    branch = git_branch
    
    git_add(path: "docs")
    git_commit(
      path: "docs",
      message: "Update docs folder for version #{version}"
    )
    push_to_git_remote(
      local_branch: branch,
      remote_branch: branch
    )
  end

  desc "Deploy to Cocoapods and push tag to master"
  lane :deploy do
    version = read_podspec['version']
    add_git_tag(tag: version)
    push_git_tags
    
    pod_push
  end
end
